"use client";

import React, { useState } from "react";
import { CyberCard } from "./CyberCard";
import { ShieldCheck, Fingerprint, Lock, Loader2, CheckCircle } from "lucide-react";
import { useWallet } from "@lazorkit/wallet";
import { useLazorContext } from "@/components/Lazorkit/LazorProvider";
import { useConsole } from "@/components/ui/DevConsole"; // Import Console

export function CheckoutWidget() {
  const { connect } = useWallet();
    const { isConnected, wallet } = useLazorContext();
      const { addLog, isOpen, toggle } = useConsole(); // Get Console Tools
        
          const [isGasless, setIsGasless] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
              const [isSuccess, setIsSuccess] = useState(false);

                // 1. The Smart Buy Handler
                  const handleBuy = async () => {
                      setIsProcessing(true);
                          
                              // Auto-open console if closed, so they see the magic
                                  if (!isOpen) toggle();

                                      if (!isConnected) {
                                            // --- LOGIN FLOW ---
                                                  addLog("[AUTH] Biometric Challenge Initiated...", "info");
                                                        await new Promise(r => setTimeout(r, 800)); // Fake delay for drama
                                                              
                                                                    try {
                                                                            addLog("[BROWSER] Requesting WebAuthn Credential...", "warning");
                                                                                    await connect();
                                                                                            addLog("[SUCCESS] Passkey Verified via Secure Enclave", "success");
                                                                                                    addLog("[NETWORK] Establishing Solana Devnet Connection...", "info");
                                                                                                          } catch (e: any) {
                                                                                                                  addLog(`[ERROR] Auth Failed: ${e.message}`, "error");
                                                                                                                        }
                                                                                                                            } else {
                                                                                                                                  // --- TRANSACTION FLOW (Simulation for now) ---
                                                                                                                                        addLog("[TX] Building Transaction Instruction...", "info");
                                                                                                                                              addLog(`[PARAM] Amount: 0.05 SOL | Item: Neural_Link_v2`, "info");
                                                                                                                                                    
                                                                                                                                                          if (isGasless) {
                                                                                                                                                                   addLog("[PAYMASTER] Requesting Sponsorship from Kora...", "warning");
                                                                                                                                                                            await new Promise(r => setTimeout(r, 1000));
                                                                                                                                                                                     addLog("[PAYMASTER] Fee Sponsored (0.000005 SOL Saved)", "success");
                                                                                                                                                                                           } else {
                                                                                                                                                                                                    addLog("[GAS] User paying network fee...", "info");
                                                                                                                                                                                                          }

                                                                                                                                                                                                                await new Promise(r => setTimeout(r, 1500)); // Fake network delay
                                                                                                                                                                                                                      addLog("[CHAIN] Transaction Confirmed (Slot: 2849102)", "success");
                                                                                                                                                                                                                            setIsSuccess(true);
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                        setIsProcessing(false);
                                                                                                                                                                                                                                          };

                                                                                                                                                                                                                                            if (isSuccess) {
                                                                                                                                                                                                                                                return (
                                                                                                                                                                                                                                                        <CyberCard className="space-y-6 text-center py-10">
                                                                                                                                                                                                                                                                    <div className="mx-auto w-16 h-16 bg-neon-green/20 rounded-full flex items-center justify-center mb-4">
                                                                                                                                                                                                                                                                                    <CheckCircle className="w-8 h-8 text-neon-green" />
                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                            <h2 className="text-2xl font-bold text-white">PAYMENT COMPLETE</h2>
                                                                                                                                                                                                                                                                                                                        <p className="text-cyber-muted text-sm">Neural Link v2 has been dispensed.</p>
                                                                                                                                                                                                                                                                                                                                    <button 
                                                                                                                                                                                                                                                                                                                                                    onClick={() => { setIsSuccess(false); window.location.reload(); }}
                                                                                                                                                                                                                                                                                                                                                                    className="text-neon-blue hover:text-white underline text-xs mt-4"
                                                                                                                                                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                                                                                                                                                                Reset Demo
                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                    </CyberCard>
                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                            return (
                                                                                                                                                                                                                                                                                                                                                                                                                                <CyberCard className="space-y-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                      {/* 1. Gasless Toggle Switch */}
                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex items-center justify-between bg-black/40 p-3 rounded border border-cyber-border">
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="flex items-center gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                              <ShieldCheck className={`w-5 h-5 ${isGasless ? "text-neon-pink" : "text-cyber-muted"}`} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="flex flex-col">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span className="text-sm font-bold text-cyber-text">Gasless Mode</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span className="text-[10px] text-cyber-muted">Sponsor pays fees</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onClick={() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setIsGasless(!isGasless);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    addLog(`[CONFIG] Switched Gas Mode to: ${!isGasless ? "SPONSORED" : "USER_PAID"}`, "info");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className={`w-12 h-6 rounded-full transition-colors relative ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    isGasless ? "bg-neon-pink/20 border-neon-pink" : "bg-cyber-gray border-cyber-border"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              } border`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className={`absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-white transition-transform ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            isGasless ? "translate-x-6 bg-neon-pink shadow-[0_0_10px_#EC4899]" : "translate-x-0"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }`} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {/* 2. Order Summary */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="space-y-2 text-sm border-t border-b border-cyber-border/50 py-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="flex justify-between text-cyber-muted">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <span>Subtotal</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span>0.05 SOL</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex justify-between items-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span className={isGasless ? "text-neon-pink" : "text-cyber-muted"}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Network Fee (Gas)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span className={isGasless ? "text-neon-pink font-bold" : "text-cyber-text"}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {isGasless ? "0.00 SOL" : "~0.000005 SOL"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {/* 3. The "Buy" / "Connect" Button */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={handleBuy}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      disabled={isProcessing}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="w-full group relative overflow-hidden rounded bg-cyber-text p-[1px] focus:outline-none focus:ring-2 focus:ring-neon-green/50"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="relative flex items-center justify-center gap-2 bg-black h-full py-3 px-4 rounded-[3px] group-hover:bg-gray-900 transition-colors">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {isProcessing ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <Loader2 className="w-5 h-5 text-neon-blue animate-spin" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <span className="text-neon-blue font-bold font-mono tracking-wider">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       PROCESSING...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ) : isConnected ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <Fingerprint className="w-5 h-5 text-neon-green" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span className="text-neon-green font-bold font-mono tracking-wider">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      CONFIRM PAYMENT
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <Lock className="w-4 h-4 text-cyber-text" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <span className="text-white font-bold font-mono tracking-wider">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  UNLOCK TO BUY
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="absolute inset-0 bg-neon-green/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </button>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {/* 4. Footer Status */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {isConnected && wallet && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="text-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <p className="text-[10px] text-cyber-muted font-mono">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  CONNECTED: <span className="text-neon-blue">{wallet.smartWallet.slice(0, 6)}...{wallet.smartWallet.slice(-4)}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </CyberCard>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }